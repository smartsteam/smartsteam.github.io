<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSL - Digital Science Lab (High Performance)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #007bff;
            --bg-light-gray: #f4f6f9;
            --bg-white: #ffffff;
            --text-dark: #333333;
            --text-gray: #666666;
            --border-color: #e0e0e0;
            --success-green: #28a745;
            --danger-red: #dc3545;
        }

        body {
            font-family: 'Noto Sans KR', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light-gray);
            margin: 0; padding: 0; color: var(--text-dark);
            height: 100vh; display: flex; flex-direction: column;
        }

        /* --- Header --- */
        .top-header {
            background-color: var(--bg-white); padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: bold; color: var(--primary-blue); font-size: 1.2rem; }
        .header-controls { display: flex; gap: 15px; align-items: center; }
        .status-badge {
            padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; background-color: #eee;
            color: var(--text-gray); display: flex; align-items: center; gap: 5px;
        }
        .status-badge.connected { background-color: #d4edda; color: var(--success-green); }
        .btn {
            padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .btn-primary { background-color: var(--primary-blue); color: white; }
        .btn-secondary { background-color: #e9ecef; color: var(--text-dark); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- Layout --- */
        .main-container { display: flex; flex: 1; padding: 20px; gap: 20px; overflow: hidden; }
        .left-panel { flex: 7; display: flex; flex-direction: column; overflow: hidden; gap: 15px; }
        .right-panel { flex: 3; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .card {
            background-color: var(--bg-white); border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 20px;
            display: flex; flex-direction: column;
        }

        /* --- Chart Section --- */
        .chart-card { flex: 1; min-height: 0; display:flex; flex-direction:column; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0; flex-wrap: wrap; gap:10px; }
        .chart-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-blue); display: flex; align-items: center; gap: 8px; }
        .chart-controls {
            display: flex; gap: 15px; align-items: center; font-size: 0.9rem;
            background-color: var(--bg-light-gray); padding: 8px 15px; border-radius: 20px;
        }
        .control-item { display: flex; align-items: center; gap: 8px; border-right: 1px solid #ddd; padding-right: 15px; }
        .control-item:last-child { border-right: none; padding-right: 0; }
        
        .toggle-switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(16px); }

        .y-inputs input, #timeFormatSelect { 
            width: 50px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; 
            background-color: var(--bg-white); 
            text-align: center; font-size: 0.9rem;
        }
        .y-inputs input { width: 50px; text-align: center; } 
        #timeFormatSelect { width: 120px; } 

        .chart-area { flex: 1; position: relative; width: 100%; height: 100%; min-height: 300px;}

        /* --- Navigator Slider --- */
        .navigator-container {
            margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #eee;
        }
        .navigator-label { font-size: 0.85rem; color: var(--text-gray); margin-bottom: 5px; display: flex; justify-content: space-between; }
        input[type="range"].history-slider { width: 100%; cursor: pointer; accent-color: var(--primary-blue); }

        /* --- Right Panel --- */
        .info-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; flex-shrink: 0; }
        .info-card { 
            flex: 1; background-color: var(--bg-white); padding: 15px; border-radius: 10px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            border: 1px solid #ddd; 
            text-align: center;
        }

        .info-label { font-size: 0.85rem; color: var(--text-gray); margin-bottom: 5px; }
        .info-value { font-size: 1.5rem; font-weight: bold; color: var(--text-dark); }

        .log-card { flex: 1; display: flex; flex-direction: column; min-height: 200px; }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: var(--success-green); font-weight: bold; flex-shrink: 0; }
        .log-tools i { cursor: pointer; margin-left: 10px; font-size: 1.1rem; }
        .table-wrapper { flex: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; text-align: center; }
        th { position: sticky; top: 0; background-color: #f8f9fa; color: var(--text-gray); padding: 8px; border-bottom: 1px solid var(--border-color); z-index: 5; }
        td { padding: 6px 8px; border-bottom: 1px solid #eee; white-space: nowrap; }
        
        .sensor-input {
            border: 1px solid transparent; background: transparent; font-weight: bold;
            color: var(--text-gray); width: 80px; text-align: center; cursor: pointer;
        }
        .sensor-input:hover, .sensor-input:focus { border: 1px solid #ddd; background: white; outline: none; border-radius: 4px; }
        
        /* ì•Œë¦¼ ë©”ì‹œì§€ (ë°ì´í„° í‘œì‹œ ì œí•œ ë“±) */
        .table-note {
            font-size: 0.8rem; color: #888; text-align: center; padding: 5px; background: #fff3cd; color: #856404; display:none;
        }

        @media (max-width: 1024px) {
            .main-container { flex-direction: column; overflow-y: auto; }
            .left-panel, .right-panel { flex: none; height: auto; }
            .chart-card { min-height: 450px; }
            .info-cards { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .info-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="top-header">
        <div class="brand"><i class="fa-solid fa-wave-square"></i><span>DSL ë””ì§€í„¸ ê³¼í•™ ì‹¤í—˜ì‹¤</span></div>
        <div class="header-controls">
            <div class="status-badge" id="connectionStatus"><i class="fa-solid fa-link-slash"></i> ì—°ê²° ì•ˆë¨</div>
            <span style="font-size: 0.9rem; color: #666;"><i class="fa-solid fa-gauge-high"></i> 115200 Baud</span>
            <button id="btnConnect" class="btn btn-primary"><i class="fa-solid fa-plug"></i> ì—°ê²°</button>
            <button id="btnStart" class="btn btn-secondary" disabled><i class="fa-solid fa-play"></i> ì‹œì‘</button>
        </div>
    </header>

    <div class="main-container">
        <div class="left-panel">
            <div class="card chart-card">
                <div class="chart-header">
                    <div class="chart-title"><i class="fa-solid fa-chart-line"></i> ì‹¤ì‹œê°„ ë°ì´í„°</div>
                    <div class="chart-controls">
                        <div class="control-item">
                            <span>ì‹œê°„ í˜•ì‹</span>
                            <select id="timeFormatSelect">
                                <option value="H_M_S">ì‹œ:ë¶„:ì´ˆ</option>
                                <option value="H_M_S_MS">ì‹œ:ë¶„:ì´ˆ:ë°€ë¦¬ì´ˆ</option>
                                <option value="M_S">ë¶„:ì´ˆ</option>
                                <option value="M_S_MS">ë¶„:ì´ˆ:ë°€ë¦¬ì´ˆ</option>
                                <option value="S_MS">ì´ˆ:ë°€ë¦¬ì´ˆ (ê²½ê³¼ ì‹œê°„)</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <span>Xì¶• ì¤Œ</span>
                            <input type="range" id="xRange" min="10" max="500" value="50" style="width:80px;">
                            <span id="xRangeValue" style="font-weight:bold;">50</span>
                        </div>
                        <div class="control-item">
                            <span>Yì¶•</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="yAutoToggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span id="yStatusText">ìë™</span>
                        </div>
                        <div class="control-item y-inputs" id="yManualInputs" style="opacity: 0.3; pointer-events: none;">
                            <input type="number" id="yMin" placeholder="Min" value="0"> ~ <input type="number" id="yMax" placeholder="Max" value="100">
                        </div>
                    </div>
                </div>
                
                <div class="chart-area">
                    <canvas id="sensorChart"></canvas>
                    <div id="chartPlaceholder" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:#aaa;">ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°ì´í„° ìˆ˜ì§‘ì„ ì‹œì‘í•˜ì„¸ìš”...</div>
                </div>

                <div class="navigator-container">
                    <div class="navigator-label">
                        <span><i class="fa-solid fa-magnifying-glass-chart"></i> ë°ì´í„° íƒìƒ‰</span>
                        <span id="navInfo">ì‹¤ì‹œê°„ ëª¨ë“œ</span>
                    </div>
                    <input type="range" id="historySlider" class="history-slider" min="0" max="0" value="0" disabled>
                </div>
                
                <div id="sensorLegend" style="display:flex; gap:15px; justify-content:center; margin-top:10px; flex-wrap:wrap; flex-shrink: 0;"></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="info-cards">
                <div class="info-card">
                    <div class="info-label">ë°ì´í„° ìˆ˜</div>
                    <div class="info-value" id="dataCountDisplay">0</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ì´ ìˆ˜ì§‘ ì‹œê°„</div>
                    <div class="info-value" id="timerDisplay">00:00:00</div>
                </div>
                <div class="info-card">
                    <div class="info-label">ì‹œì‘/ì¬ì‹œì‘ íšŸìˆ˜</div>
                    <div class="info-value" id="startCountDisplay">0</div>
                </div>
            </div>

            <div class="card log-card">
                <div class="log-header">
                    <span><i class="fa-solid fa-list-ol"></i> ë°ì´í„° ë¡œê·¸</span>
                    <div class="log-tools">
                        <i class="fa-solid fa-download" id="btnDownload" title="CSV ë‹¤ìš´ë¡œë“œ" style="color:var(--primary-blue)"></i>
                        <i class="fa-solid fa-trash-can" id="btnDeleteSelected" title="ì„ íƒ ì‚­ì œ" style="color:var(--danger-red)"></i>
                    </div>
                </div>
                <div id="tableNote" class="table-note">ğŸš€ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ìµœê·¼ 50ê°œë§Œ í‘œì‹œ ì¤‘... (ì •ì§€ ì‹œ ì „ì²´ í‘œì‹œ)</div>
                <div class="table-wrapper">
                    <table>
                        <thead id="tableHead">
                            <tr><th><input type="checkbox" id="checkAll"></th><th>ì‹œê°„</th><th>ê°’</th></tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="3" class="empty-log">ê¸°ë¡ëœ ë°ì´í„° ì—†ìŒ</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card guide-card">
                <h4>ì‚¬ìš© ë°©ë²•:</h4>
                <ol>
                    <li>ì‹œê°„ í˜•ì‹ì„ ì„ íƒí•˜ì—¬ Xì¶•ê³¼ ë¡œê·¸ë¥¼ ì»¤ìŠ¤í…€í•˜ì„¸ìš”.</li>
                    <li>'ì—°ê²°' í›„ 'ì‹œì‘' ë²„íŠ¼ìœ¼ë¡œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì„¸ìš”.</li>
                    <li><span style="color:#007bff; font-weight:bold;">íŒŒë€ ì </span>: ì‹œì‘, <span style="color:#dc3545; font-weight:bold;">ë¹¨ê°„ ì </span>: ì •ì§€ ì§€ì </li>
                </ol>
            </div>
        </div>
    </div>

    <datalist id="sensorTypes">
        <option value="ì˜¨ë„">
        <option value="ìŠµë„">
        <option value="ì¡°ë„">
        <option value="ì „ì••">
        <option value="ì „ë¥˜">
        <option value="ê¸°ì••">
        <option value="ì†Œë¦¬">
        <option value="ê±°ë¦¬">
        <option value="pH">
    </datalist>

    <script>
        // --- CONSTANTS & Variables ---
        const MAX_DATA_POINTS = 1500; // ìµœëŒ€ ì €ì¥ ë°ì´í„° ìˆ˜
        const MAX_TABLE_ROWS_LIVE = 50; // [ë ‰ ë°©ì§€ í•µì‹¬] ìˆ˜ì§‘ ì¤‘ í‘œì— í‘œì‹œí•  ìµœëŒ€ í–‰ ìˆ˜
        const CHART_THROTTLE_MS = 200; // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì£¼ê¸°
        const TABLE_UPDATE_MS = 300;   // í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì£¼ê¸°
        
        let port, reader, inputDone;
        let isConnected = false, isCollecting = false;
        let dataCounter = 0, allData = [], sensorCount = 0;
        let accumulatedTime = 0, currentSessionStart = 0, timerInterval = null;
        let isNavigating = false;
        let sensorNames = []; 
        let sessionStartTimeAbsolute = 0; 
        let startCount = 0;
        let throttleTimer = null; 
        
        // ë°ì´í„° ë²„í¼
        let tableUpdateInterval = null;

        // Start/Stop marker flags
        let shouldMarkStart = false;

        const colors = ['#007bff', '#6f42c1', '#28a745', '#dc3545', '#ffc107', '#17a2b8'];

        // Time Format
        const TIME_FORMATS = {
            'H_M_S': { label: 'ì‹œ:ë¶„:ì´ˆ', opts: { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false } },
            'H_M_S_MS': { label: 'ì‹œ:ë¶„:ì´ˆ:ë°€ë¦¬ì´ˆ', opts: { hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3, hour12: false } },
            'M_S': { label: 'ë¶„:ì´ˆ', opts: { minute: '2-digit', second: '2-digit' } },
            'M_S_MS': { label: 'ë¶„:ì´ˆ:ë°€ë¦¬ì´ˆ', opts: { minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 } },
            'S_MS': { label: 'ì´ˆ:ë°€ë¦¬ì´ˆ (ê²½ê³¼ ì‹œê°„)', custom: true }
        };
        let currentTimeFormat = 'H_M_S';
        const unitMap = { 'ì˜¨ë„': 'Â°C', 'ìŠµë„': '%', 'ì¡°ë„': 'lx', 'ì „ì••': 'V', 'ì „ë¥˜': 'A', 'ê¸°ì••': 'hPa', 'ì†Œë¦¬': 'dB', 'ê±°ë¦¬': 'cm', 'pH': '' };

        // --- DOM Elements ---
        const els = {
            btnConnect: document.getElementById('btnConnect'),
            btnStart: document.getElementById('btnStart'),
            status: document.getElementById('connectionStatus'),
            chartPlaceholder: document.getElementById('chartPlaceholder'),
            count: document.getElementById('dataCountDisplay'),
            timer: document.getElementById('timerDisplay'),
            startCountDisplay: document.getElementById('startCountDisplay'),
            tableBody: document.getElementById('tableBody'),
            tableHead: document.getElementById('tableHead'),
            tableNote: document.getElementById('tableNote'),
            legend: document.getElementById('sensorLegend'),
            timeFormatSelect: document.getElementById('timeFormatSelect'),
            xRange: document.getElementById('xRange'),
            xVal: document.getElementById('xRangeValue'),
            slider: document.getElementById('historySlider'),
            navInfo: document.getElementById('navInfo'),
            yAuto: document.getElementById('yAutoToggle'),
            yStatus: document.getElementById('yStatusText'),
            yInputs: document.getElementById('yManualInputs'),
            yMin: document.getElementById('yMin'),
            yMax: document.getElementById('yMax')
        };

        // --- Helper Functions ---
        function formatTime(date) {
            if (currentTimeFormat === 'S_MS') {
                if (sessionStartTimeAbsolute === 0) return '00.000';
                const elapsedMs = date.getTime() - sessionStartTimeAbsolute;
                const totalSeconds = Math.floor(elapsedMs / 1000);
                const ms = elapsedMs % 1000;
                return `${String(totalSeconds).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
            }
            const opts = TIME_FORMATS[currentTimeFormat].opts;
            return new Intl.DateTimeFormat('ko-KR', opts).format(date).replace(/:\s/g, ':');
        }

        // --- Chart ---
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { display: true, ticks: { autoSkip: true, maxTicksLimit: 7 }, grid: { display: false } },
                    y: { grid: { color: '#f0f0f0' } }
                },
                plugins: { legend: { display: false } }
            }
        });

        // --- Connection ---
        els.btnConnect.addEventListener('click', async () => {
            if (!isConnected) {
                try {
                    if (!("serial" in navigator)) return alert("Web Serial ë¯¸ì§€ì› ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });
                    
                    isConnected = true;
                    els.btnConnect.innerHTML = '<i class="fa-solid fa-link-slash"></i> ì—°ê²° í•´ì œ';
                    els.btnConnect.classList.replace('btn-primary', 'btn-secondary');
                    els.btnStart.disabled = false;
                    els.status.innerHTML = '<i class="fa-solid fa-link"></i> ì—°ê²°ë¨';
                    els.status.classList.add('connected');
                    if (sessionStartTimeAbsolute === 0) sessionStartTimeAbsolute = Date.now(); 
                } catch (e) { console.error(e); alert("ì—°ê²° ì‹¤íŒ¨: " + e.message); }
            } else {
                await forceStop(); // ì•ˆì „í•˜ê²Œ ì •ì§€ í›„ í•´ì œ
                if (port) { await port.close(); port = null; }
                resetState();
            }
        });

        // --- Start/Stop Logic (ê°œì„ ë¨) ---
        els.btnStart.addEventListener('click', async () => {
            if (!isConnected) return;
            
            if (!isCollecting) {
                // START
                isCollecting = true;
                startCount++; els.startCountDisplay.innerText = startCount;
                
                els.btnStart.innerHTML = '<i class="fa-solid fa-stop"></i> ì •ì§€';
                els.btnStart.classList.replace('btn-secondary', 'btn-primary');
                els.chartPlaceholder.style.display = 'none';
                els.tableNote.style.display = 'block'; // ì•Œë¦¼ í‘œì‹œ
                
                isNavigating = false; els.slider.disabled = true; els.navInfo.innerText = "ë°ì´í„° ìˆ˜ì§‘ ì¤‘...";
                currentSessionStart = Date.now();
                
                // ê¸°ì¡´ íƒ€ì´ë¨¸ í´ë¦¬ì–´
                if(timerInterval) clearInterval(timerInterval);
                if(tableUpdateInterval) clearInterval(tableUpdateInterval);

                timerInterval = setInterval(updateTimer, 100);
                tableUpdateInterval = setInterval(updateTableLive, TABLE_UPDATE_MS); // ì£¼ê¸°ì  í…Œì´ë¸” ì—…ë°ì´íŠ¸
                
                if (allData.length > 0) shouldMarkStart = true; 
                if (sessionStartTimeAbsolute === 0) sessionStartTimeAbsolute = Date.now();

                readSerialLoop();
            } else {
                // STOP
                await forceStop();
            }
        });

        async function forceStop() {
            // 1. ìƒíƒœ í”Œë˜ê·¸ ì¦‰ì‹œ ë³€ê²½ (ë£¨í”„ ì¤‘ë‹¨ìš©)
            isCollecting = false;
            
            // 2. íƒ€ì´ë¨¸ ì¦‰ì‹œ ì œê±° (UI íë¦„ ë°©ì§€)
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            if (tableUpdateInterval) { clearInterval(tableUpdateInterval); tableUpdateInterval = null; }

            // 3. UI ì—…ë°ì´íŠ¸
            els.btnStart.innerHTML = '<i class="fa-solid fa-play"></i> ì‹œì‘';
            els.btnStart.classList.replace('btn-primary', 'btn-secondary');
            els.tableNote.style.display = 'none';

            // 4. ë§ˆì§€ë§‰ ë°ì´í„° ì²˜ë¦¬ (ë¹¨ê°„ ì )
            if (allData.length > 0) {
                allData[allData.length - 1].isSessionEnd = true;
                if (!isNavigating) updateChartRealtime();
            }

            // 5. ì‹œë¦¬ì–¼ ë¦¬ë” ì·¨ì†Œ
            if (reader) { 
                try { await reader.cancel(); } catch(e){}
                await inputDone.catch(() => {});
                reader = null; inputDone = null;
            }

            // 6. ëˆ„ì  ì‹œê°„ ì €ì¥
            if (currentSessionStart > 0) accumulatedTime += (Date.now() - currentSessionStart);
            
            // 7. [ì¤‘ìš”] ì „ì²´ ë°ì´í„° í…Œì´ë¸”ì— ë Œë”ë§ (ë¦¬ë·° ëª¨ë“œ)
            renderTableFull(); 
            enableNavigation();
        }

        function resetState() {
            isConnected = isCollecting = false;
            els.btnConnect.innerHTML = '<i class="fa-solid fa-plug"></i> ì—°ê²°';
            els.btnConnect.classList.replace('btn-secondary', 'btn-primary');
            els.btnStart.disabled = true;
            els.btnStart.innerHTML = '<i class="fa-solid fa-play"></i> ì‹œì‘';
            els.status.innerHTML = '<i class="fa-solid fa-link-slash"></i> ì—°ê²° ì•ˆë¨';
            els.status.classList.remove('connected');
            els.chartPlaceholder.style.display = 'block';
            els.tableNote.style.display = 'none';
            
            if(timerInterval) clearInterval(timerInterval);
            if(tableUpdateInterval) clearInterval(tableUpdateInterval);
            els.timer.innerText = "00:00:00";
            accumulatedTime = 0; sessionStartTimeAbsolute = 0;
            
            dataCounter = 0; allData = []; sensorCount = 0; sensorNames = [];
            startCount = 0; shouldMarkStart = false;
            
            els.startCountDisplay.innerText = "0"; 
            els.count.innerText = "0";
            
            chart.data.datasets = []; chart.update();
            els.tableBody.innerHTML = '<tr><td colspan="3" class="empty-log"> ê¸°ë¡ëœ ë°ì´í„° ì—†ìŒ </td></tr>';
            els.legend.innerHTML = '';
            els.slider.disabled = true; els.slider.value = 0;
            els.navInfo.innerText = "ì‹¤ì‹œê°„ ëª¨ë“œ";
        }

        function updateTimer() {
            if(!isCollecting) return; // ì´ì¤‘ ì•ˆì „ì¥ì¹˜
            const t = accumulatedTime + (Date.now() - currentSessionStart);
            const m = Math.floor(t/60000), s = Math.floor((t%60000)/1000), ms = Math.floor((t%1000)/10);
            els.timer.innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}:${String(ms).padStart(2,'0')}`;
        }

        async function readSerialLoop() {
            const textDecoder = new TextDecoderStream();
            inputDone = port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable.getReader();
            let buffer = "";
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done || !isCollecting) break; // ì¦‰ì‹œ íƒˆì¶œ
                    if (value) {
                        buffer += value;
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        for (const line of lines) {
                            if (!isCollecting) break;
                            if (line.trim()) processData(line.trim());
                        }
                    }
                }
            } catch (e) {} finally { if (reader) reader.releaseLock(); }
        }
        
        // --- Data Processing ---
        function processData(raw) {
            const vals = raw.split(',').map(v => parseFloat(v.trim()));
            if (vals.some(isNaN) || vals.length === 0) return;

            if (sensorCount === 0 || sensorCount !== vals.length) {
                sensorCount = vals.length;
                initStructure(sensorCount);
            }

            dataCounter++;
            const now = new Date();
            const timeStr = formatTime(now);
            
            const rowData = { 
                id: dataCounter, time: timeStr, values: vals, rawDate: now,
                isSessionStart: shouldMarkStart, isSessionEnd: false
            };
            
            allData.push(rowData);
            if (shouldMarkStart) shouldMarkStart = false;

            // ë°ì´í„° ì œí•œ (ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ)
            if (allData.length > MAX_DATA_POINTS) allData.shift();

            els.count.innerText = allData.length;
            
            // ì°¨íŠ¸ëŠ” ìŠ¤ë¡œí‹€ë§ ì ìš©í•˜ì—¬ ì—…ë°ì´íŠ¸
            if (!isNavigating) scheduleChartUpdate(); 
        }

        function scheduleChartUpdate() {
            if (throttleTimer) return;
            throttleTimer = setTimeout(() => {
                if (!isNavigating && isCollecting) updateChartRealtime();
                throttleTimer = null;
            }, CHART_THROTTLE_MS);
        }

        // --- Table Rendering (ìµœì í™”) ---
        function updateTableLive() {
            if (!isCollecting) return;
            // ë¼ì´ë¸Œ ëª¨ë“œì—ì„œëŠ” ìµœê·¼ ë°ì´í„°ë§Œ ë Œë”ë§í•˜ì—¬ ë ‰ ë°©ì§€
            const recentData = allData.slice(-MAX_TABLE_ROWS_LIVE).reverse();
            renderTableData(recentData);
        }

        function renderTableFull() {
            // ì •ì§€ ì‹œ ì „ì²´ ë°ì´í„° ë Œë”ë§
            renderTableData([...allData].reverse());
        }

        function renderTableData(dataArray) {
            // DocumentFragment ì‚¬ìš©ìœ¼ë¡œ ë¦¬í”Œë¡œìš° 1íšŒë¡œ ì œí•œ
            const fragment = document.createDocumentFragment();
            
            if (dataArray.length === 0) {
                els.tableBody.innerHTML = '<tr><td colspan="3" class="empty-log">ê¸°ë¡ëœ ë°ì´í„° ì—†ìŒ</td></tr>';
                return;
            }

            dataArray.forEach(d => {
                const tr = document.createElement('tr');
                let html = `<td><input type="checkbox" class="row-checkbox" data-id="${d.id}"></td><td>${d.time}</td>`;
                d.values.forEach(val => html += `<td>${val}</td>`);
                tr.innerHTML = html;
                fragment.appendChild(tr);
            });
            
            els.tableBody.innerHTML = '';
            els.tableBody.appendChild(fragment);
        }

        // --- ETC (Init, Chart Update, etc) ---
        function initStructure(cnt) {
            let html = `<tr><th style="width:40px;"><input type="checkbox" id="checkAll"></th><th>ì‹œê°„</th>`;
            els.legend.innerHTML = '';
            chart.data.datasets = [];
            sensorNames = [];

            for(let i=0; i<cnt; i++) {
                const defName = sensorNames[i] || `ì„¼ì„œ ${i+1}`;
                sensorNames.push(defName);
                html += `<th><input type="text" list="sensorTypes" class="sensor-input" data-index="${i}" value="${defName}" onchange="updateSensorMeta(this)" onclick="this.select()"></th>`;
                const col = colors[i % colors.length];
                chart.data.datasets.push({
                    label: defName, data: [], borderColor: col, backgroundColor: col,
                    borderWidth: 2, pointRadius: 0, tension: 0.3,
                    pointRadius: [], pointBackgroundColor: [], pointBorderColor: []
                });
                updateLegend();
            }
            html += `</tr>`;
            els.tableHead.innerHTML = html;
            els.tableBody.innerHTML = '';

            document.getElementById('checkAll').addEventListener('change', e => {
                document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = e.target.checked);
            });
        }

        window.updateSensorMeta = function(input) {
            const idx = parseInt(input.dataset.index);
            let val = input.value.trim().replace(/\s*\(.*\)/g, '');
            if(!val) val = `ì„¼ì„œ ${idx+1}`;
            let unit = ""; let baseName = val;
            for (const key in unitMap) {
                if (val.includes(key) && key.length > 1) { unit = unitMap[key]; break; }
            }
            const displayName = unit ? `${baseName} (${unit})` : baseName;
            sensorNames[idx] = displayName;
            chart.data.datasets[idx].label = displayName;
            input.value = displayName;
            updateLegend();
            chart.update();
        }

        function updateLegend() {
            els.legend.innerHTML = '';
            sensorNames.forEach((name, i) => {
                const col = colors[i % colors.length];
                els.legend.innerHTML += `<div style="display:flex;align-items:center;gap:5px;font-size:0.9rem;"><div style="width:10px;height:10px;border-radius:50%;background:${col}"></div> ${name}</div>`;
            });
        }

        function updateChartRealtime() {
            const win = parseInt(els.xRange.value);
            const start = Math.max(0, allData.length - win);
            renderChart(allData.slice(start));
        }

        function enableNavigation() {
            isNavigating = true;
            els.slider.disabled = false;
            updateSliderRange();
            els.navInfo.innerText = "ìŠ¬ë¼ì´ë”ë¡œ ì´ë™í•˜ì—¬ íƒìƒ‰";
        }

        function updateSliderRange() {
            const win = parseInt(els.xRange.value);
            const max = Math.max(0, allData.length - win);
            els.slider.max = max;
            els.slider.value = max; 
        }

        els.slider.addEventListener('input', (e) => {
            if (isCollecting) return;
            const start = parseInt(e.target.value);
            const win = parseInt(els.xRange.value);
            renderChart(allData.slice(start, start + win));
        });

        function renderChart(viewData) {
            chart.data.labels = viewData.map(d => d.time);
            for(let i=0; i<sensorCount; i++) {
                if(chart.data.datasets[i]) {
                    chart.data.datasets[i].data = viewData.map(d => d.values[i]);
                    chart.data.datasets[i].pointRadius = viewData.map(d => (d.isSessionStart || d.isSessionEnd) ? 6 : 0);
                    chart.data.datasets[i].pointBackgroundColor = viewData.map(d => d.isSessionStart ? '#007bff' : (d.isSessionEnd ? '#dc3545' : 'transparent'));
                    chart.data.datasets[i].pointBorderColor = viewData.map(d => d.isSessionStart ? '#007bff' : (d.isSessionEnd ? '#dc3545' : 'transparent'));
                }
            }
            chart.update('none');
        }

        function handleTimeFormatChange() {
            const newFormat = els.timeFormatSelect.value;
            if (newFormat === currentTimeFormat) return;
            currentTimeFormat = newFormat;
            allData.forEach(row => { row.time = formatTime(row.rawDate); });
            
            if (isCollecting) updateTableLive();
            else renderTableFull();
            
            if (!isNavigating) updateChartRealtime();
            else els.slider.dispatchEvent(new Event('input'));
        }
        
        els.timeFormatSelect.addEventListener('change', handleTimeFormatChange);
        els.yAuto.addEventListener('change', updateYAxis);
        els.yMin.addEventListener('change', updateYAxis);
        els.yMax.addEventListener('change', updateYAxis);
        els.xRange.addEventListener('input', (e) => {
            els.xVal.innerText = e.target.value;
            if (isCollecting) updateChartRealtime();
            else { updateSliderRange(); els.slider.dispatchEvent(new Event('input')); }
        });

        function updateYAxis() {
            if(els.yAuto.checked) {
                els.yStatus.innerText = "ìë™"; els.yInputs.style.opacity = '0.3'; els.yInputs.style.pointerEvents = 'none';
                chart.options.scales.y.min = null; chart.options.scales.y.max = null;
            } else {
                els.yStatus.innerText = "ìˆ˜ë™"; els.yInputs.style.opacity = '1'; els.yInputs.style.pointerEvents = 'auto';
                const min = parseFloat(els.yMin.value), max = parseFloat(els.yMax.value);
                if(!isNaN(min)) chart.options.scales.y.min = min;
                if(!isNaN(max)) chart.options.scales.y.max = max;
            }
            chart.update();
        }

        document.getElementById('btnDownload').addEventListener('click', () => {
            if (allData.length === 0) return alert("ë°ì´í„° ì—†ìŒ");
            let csv = "ID,Time," + sensorNames.join(',') + "\r\n";
            allData.forEach(d => csv += `${d.id},${d.time},${d.values.join(',')}\r\n`);
            const link = document.createElement("a");
            link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            link.download = `DSL_Data_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.csv`;
            link.click();
        });

        document.getElementById('btnDeleteSelected').addEventListener('click', () => {
            const chk = document.querySelectorAll('.row-checkbox:checked');
            if(chk.length === 0) return alert("ì„ íƒëœ í•­ëª© ì—†ìŒ");
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const ids = Array.from(chk).map(c => parseInt(c.dataset.id));
            allData = allData.filter(d => !ids.includes(d.id));
            
            if (isCollecting) updateTableLive();
            else renderTableFull();

            if(!isCollecting) { updateSliderRange(); els.slider.dispatchEvent(new Event('input')); }
            else updateChartRealtime();
            
            els.count.innerText = allData.length;
            document.getElementById('checkAll').checked = false;
        });

        updateYAxis(); 
    </script>
</body>
</html>
