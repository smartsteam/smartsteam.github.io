<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë””ì§€í„¸ ê³¼í•™ì‹¤í—˜ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --bg-color: #ecf0f1;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        header h1 {
            margin: 0;
            font-size: 2rem;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .control-group {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
        }

        .control-group h3 {
            margin-top: 0;
            font-size: 1.1rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: opacity 0.2s;
            flex: 1;
        }

        button:hover { opacity: 0.9; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #btnConnect { background-color: var(--accent-color); }
        #btnDisconnect { background-color: var(--danger-color); }
        #btnStart { background-color: var(--success-color); }
        #btnPause { background-color: #f39c12; }

        /* ìŠ¬ë¼ì´ë” ë° ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .setting-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] { flex: 1; }
        input[type="number"] { width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        
        .radio-group {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        /* ì°¨íŠ¸ ë° í…Œì´ë¸” ë ˆì´ì•„ì›ƒ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) { background-color: #f9f9f9; }

        /* ìƒíƒœ í‘œì‹œì¤„ */
        #statusMsg {
            margin-top: 10px;
            font-weight: bold;
            color: var(--accent-color);
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ”¬ ë””ì§€í„¸ ê³¼í•™ì‹¤í—˜ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ì´ì§€ë©”ì´ì»¤(Easymaker) ì„¼ì„œ ë°ì´í„° ì‹¤ì‹œê°„ ë¶„ì„</p>
    </header>

    <div class="control-panel">
        <div class="control-group">
            <h3>ğŸ”Œ ì¥ì¹˜ ì—°ê²° ì œì–´</h3>
            <div class="btn-group">
                <button id="btnConnect">ì¥ì¹˜ ì—°ê²°</button>
                <button id="btnDisconnect" disabled>ì—°ê²° í•´ì œ</button>
            </div>
            <div class="btn-group" style="margin-top: 10px;">
                <button id="btnStart" disabled>ìˆ˜ì§‘ ì‹œì‘</button>
                <button id="btnPause" disabled>ì¼ì‹œ ì •ì§€</button>
            </div>
            <div id="statusMsg">ìƒíƒœ: ì—°ê²° ëŒ€ê¸°ì¤‘...</div>
        </div>

        <div class="control-group">
            <h3>ğŸ“Š ê·¸ë˜í”„ ì„¤ì •</h3>
            
            <div class="setting-item">
                <label>Xì¶• ë°ì´í„° ìˆ˜(1~500):</label>
                <span id="xRangeValue" style="font-weight:bold; color:var(--accent-color);">50</span>
            </div>
            <div class="setting-item">
                <input type="range" id="xRange" min="1" max="500" value="50">
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

            <div class="radio-group">
                <label><input type="radio" name="yMode" value="auto" checked> Yì¶• ìë™(Auto)</label>
                <label><input type="radio" name="yMode" value="manual"> Yì¶• ìˆ˜ë™(Manual)</label>
            </div>
            <div class="setting-item">
                <label>ìµœì†Œê°’(Min):</label>
                <input type="number" id="yMin" disabled placeholder="0">
            </div>
            <div class="setting-item">
                <label>ìµœëŒ€ê°’(Max):</label>
                <input type="number" id="yMax" disabled placeholder="100">
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ“ˆ ì‹¤ì‹œê°„ ë³€í™” ê·¸ë˜í”„</h3>
            <div class="chart-container">
                <canvas id="sensorChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">ğŸ“ ë°ì´í„° ë¡œê·¸</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ìˆœë²ˆ</th>
                            <th>ì‹œê°„</th>
                            <th>ê°’</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. ë³€ìˆ˜ ì„ ì–¸ ---
    let port;
    let reader;
    let inputDone;
    let outputStream;
    let inputStream;
    let isConnected = false;
    let isCollecting = false;
    let isPaused = false;
    let dataCounter = 0; // ë°ì´í„° ìˆœë²ˆ
    let allData = []; // ì „ì²´ ë°ì´í„° ì €ì¥ì†Œ (ìˆœë²ˆ, ì‹œê°„, ê°’)

    // DOM ìš”ì†Œ ì°¸ì¡°
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const statusMsg = document.getElementById('statusMsg');
    const tableBody = document.getElementById('tableBody');
    
    const xRange = document.getElementById('xRange');
    const xRangeValue = document.getElementById('xRangeValue');
    const yModeRadios = document.getElementsByName('yMode');
    const yMinInput = document.getElementById('yMin');
    const yMaxInput = document.getElementById('yMax');

    // --- 2. Chart.js ì´ˆê¸°í™” ---
    const ctx = document.getElementById('sensorChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'ì„¼ì„œ ë°ì´í„°',
                data: [],
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                borderWidth: 2,
                tension: 0.1, // ë¶€ë“œëŸ¬ìš´ ê³¡ì„ 
                pointRadius: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, // ì‹¤ì‹œê°„ ì„±ëŠ¥ì„ ìœ„í•´ ì• ë‹ˆë©”ì´ì…˜ ë”
            scales: {
                x: {
                    title: { display: true, text: 'ì‹œê°„/ìˆœì„œ' }
                },
                y: {
                    title: { display: true, text: 'ì„¼ì„œ ê°’' },
                    beginAtZero: false
                }
            }
        }
    });

    // --- 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---

    // Web Serial ë¯¸ì§€ì› ë¸Œë¼ìš°ì € ì²´í¬
    if (!("serial" in navigator)) {
        alert("ì´ ë¸Œë¼ìš°ì €ëŠ” Web Serial APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome ë˜ëŠ” Edgeë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
        btnConnect.disabled = true;
        statusMsg.innerText = "ìƒíƒœ: Web Serial API ë¯¸ì§€ì› ë¸Œë¼ìš°ì €";
        statusMsg.style.color = "red";
    }

    // ì—°ê²° ë²„íŠ¼
    btnConnect.addEventListener('click', async () => {
        try {
            port = await navigator.serial.requestPort();
            // ì´ì§€ë©”ì´ì»¤ í†µì‹ ì†ë„ 115200 ì„¤ì •
            await port.open({ baudRate: 115200 });
            
            isConnected = true;
            updateUIState();
            statusMsg.innerText = "ìƒíƒœ: ì—°ê²°ë¨ (ëŒ€ê¸°ì¤‘)";
            statusMsg.style.color = "#27ae60";
        } catch (err) {
            console.error('Connection error:', err);
            alert('ì¥ì¹˜ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });

    // í•´ì œ ë²„íŠ¼
    btnDisconnect.addEventListener('click', async () => {
        if (reader) {
            await reader.cancel();
            await inputDone.catch(() => {});
            reader = null;
            inputDone = null;
        }
        if (port) {
            await port.close();
            port = null;
        }
        isConnected = false;
        isCollecting = false;
        isPaused = false;
        updateUIState();
        statusMsg.innerText = "ìƒíƒœ: ì—°ê²° í•´ì œë¨";
        statusMsg.style.color = "#c0392b";
    });

    // ìˆ˜ì§‘ ì‹œì‘ ë²„íŠ¼
    btnStart.addEventListener('click', () => {
        if (!isConnected) return;
        if (!isCollecting) {
            // ì²˜ìŒ ì‹œì‘
            isCollecting = true;
            statusMsg.innerText = "ìƒíƒœ: ë°ì´í„° ìˆ˜ì§‘ ì¤‘...";
            readSerialLoop(); // ë°ì´í„° ì½ê¸° ë£¨í”„ ì‹œì‘
        }
        isPaused = false;
        btnStart.disabled = true;
        btnPause.disabled = false;
        btnPause.innerText = "ì¼ì‹œ ì •ì§€";
    });

    // ì¼ì‹œ ì •ì§€ ë²„íŠ¼
    btnPause.addEventListener('click', () => {
        if (!isCollecting) return;
        isPaused = !isPaused;
        if (isPaused) {
            statusMsg.innerText = "ìƒíƒœ: ì¼ì‹œ ì •ì§€ë¨";
            btnPause.innerText = "ë‹¤ì‹œ ì‹œì‘";
        } else {
            statusMsg.innerText = "ìƒíƒœ: ë°ì´í„° ìˆ˜ì§‘ ì¤‘...";
            btnPause.innerText = "ì¼ì‹œ ì •ì§€";
        }
    });

    // Xì¶• ìŠ¬ë¼ì´ë” ë³€ê²½
    xRange.addEventListener('input', (e) => {
        const val = e.target.value;
        xRangeValue.innerText = val;
        updateChartDisplay(); // ì°¨íŠ¸ ì¦‰ì‹œ ê°±ì‹ 
    });

    // Yì¶• ëª¨ë“œ ë³€ê²½ (ë¼ë””ì˜¤ ë²„íŠ¼)
    yModeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            const isManual = e.target.value === 'manual';
            yMinInput.disabled = !isManual;
            yMaxInput.disabled = !isManual;
            updateChartScales();
        });
    });

    // Yì¶• Min/Max ì…ë ¥ ë³€ê²½
    yMinInput.addEventListener('input', updateChartScales);
    yMaxInput.addEventListener('input', updateChartScales);


    // --- 4. í•µì‹¬ ë¡œì§ í•¨ìˆ˜ ---

    function updateUIState() {
        btnConnect.disabled = isConnected;
        btnDisconnect.disabled = !isConnected;
        btnStart.disabled = !isConnected || isCollecting;
        btnPause.disabled = !isCollecting;
    }

    // ì‹œë¦¬ì–¼ ë°ì´í„° ì½ê¸° ë£¨í”„
    async function readSerialLoop() {
        const textDecoder = new TextDecoderStream();
        inputDone = port.readable.pipeTo(textDecoder.writable);
        reader = textDecoder.readable.getReader();

        let buffer = "";

        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                if (value) {
                    buffer += value;
                    // ì¤„ë°”ê¿ˆ ë¬¸ìë¡œ ë°ì´í„° ë¶„ë¦¬
                    const lines = buffer.split('\n');
                    // ë§ˆì§€ë§‰ ì¡°ê°ì€ ë¶ˆì™„ì „í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë²„í¼ì— ë‚¨ê¹€
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine && !isPaused) {
                            processData(trimmedLine);
                        }
                    }
                }
            }
        } catch (error) {
            console.error("Read error:", error);
            statusMsg.innerText = "ìƒíƒœ: í†µì‹  ì˜¤ë¥˜ ë°œìƒ";
        } finally {
            reader.releaseLock();
        }
    }

    // ë°ì´í„° ì²˜ë¦¬ ë° UI ì—…ë°ì´íŠ¸
    function processData(rawData) {
        // ìˆ«ìì¸ì§€ í™•ì¸
        const floatVal = parseFloat(rawData);
        if (isNaN(floatVal)) return; // ìˆ«ìê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ

        dataCounter++;
        const now = new Date();
        const timeStr = now.toLocaleTimeString();

        // 1. ë°ì´í„° ì €ì¥
        const dataPoint = {
            id: dataCounter,
            time: timeStr,
            value: floatVal
        };
        allData.push(dataPoint);

        // 2. í‘œ ì—…ë°ì´íŠ¸ (ìµœì‹  ë°ì´í„°ê°€ ìœ„ë¡œ)
        const row = `<tr>
            <td>${dataPoint.id}</td>
            <td>${dataPoint.time}</td>
            <td>${dataPoint.value}</td>
        </tr>`;
        tableBody.insertAdjacentHTML('afterbegin', row);

        // 3. ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        updateChartDisplay();
    }

    // ì°¨íŠ¸ í™”ë©´ ê°±ì‹  (ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ì ìš©)
    function updateChartDisplay() {
        const windowSize = parseInt(xRange.value); // ìŠ¬ë¼ì´ë” ê°’
        
        // ì „ì²´ ë°ì´í„° ì¤‘ ë§ˆì§€ë§‰ Nê°œë§Œ ìë¥´ê¸°
        const visibleData = allData.slice(-windowSize);

        // ì°¨íŠ¸ ë°ì´í„°ì…‹ ì—…ë°ì´íŠ¸
        chart.data.labels = visibleData.map(d => d.time); // Xì¶•: ì‹œê°„
        chart.data.datasets[0].data = visibleData.map(d => d.value); // Yì¶•: ê°’

        chart.update();
    }

    // Yì¶• ìŠ¤ì¼€ì¼ ì„¤ì • ì—…ë°ì´íŠ¸
    function updateChartScales() {
        const mode = document.querySelector('input[name="yMode"]:checked').value;
        
        if (mode === 'auto') {
            chart.options.scales.y.min = null;
            chart.options.scales.y.max = null;
        } else {
            const minVal = parseFloat(yMinInput.value);
            const maxVal = parseFloat(yMaxInput.value);
            
            // ê°’ì´ ìœ íš¨í•  ë•Œë§Œ ì ìš©
            if (!isNaN(minVal)) chart.options.scales.y.min = minVal;
            if (!isNaN(maxVal)) chart.options.scales.y.max = maxVal;
        }
        chart.update();
    }
</script>

</body>
</html>