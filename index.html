<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©€í‹° ì„¼ì„œ ê³¼í•™ì‹¤í—˜ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --bg-color: #ecf0f1;
            --card-bg: #ffffff;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 20px; color: var(--primary-color); }
        header h1 { margin: 0; font-size: 2rem; }
        header p { margin: 5px 0 0; color: #666; }

        .control-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .control-group { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        .control-group h3 { margin-top: 0; font-size: 1.1rem; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; margin-bottom: 15px; }

        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: opacity 0.2s; flex: 1; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #btnConnect { background-color: var(--accent-color); }
        #btnDisconnect { background-color: var(--danger-color); }
        #btnStart { background-color: var(--success-color); }
        #btnPause { background-color: #f39c12; }

        .setting-item { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; }
        input[type="number"] { width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; }

        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } }
        .card { background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .chart-container { position: relative; height: 400px; width: 100%; }
        .table-container { height: 400px; overflow-y: auto; border: 1px solid #eee; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; text-align: center; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; white-space: nowrap; }
        th { background-color: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        #statusMsg { margin-top: 10px; font-weight: bold; color: var(--accent-color); }
        
        /* ì„¼ì„œ ê°’ ë²”ë¡€ ìŠ¤íƒ€ì¼ */
        .sensor-legend { display: flex; gap: 10px; margin-bottom: 10px; font-size: 0.9rem; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .color-box { width: 12px; height: 12px; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ”¬ ë©€í‹° ì„¼ì„œ ê³¼í•™ì‹¤í—˜ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ë°ì´í„° í¬ë§· ì˜ˆì‹œ: <code>24.5, 60.1, 1012</code> (ì‰¼í‘œë¡œ êµ¬ë¶„)</p>
    </header>

    <div class="control-panel">
        <div class="control-group">
            <h3>ğŸ”Œ ì¥ì¹˜ ì—°ê²° ì œì–´</h3>
            <div class="btn-group">
                <button id="btnConnect">ì¥ì¹˜ ì—°ê²°</button>
                <button id="btnDisconnect" disabled>ì—°ê²° í•´ì œ</button>
            </div>
            <div class="btn-group" style="margin-top: 10px;">
                <button id="btnStart" disabled>ìˆ˜ì§‘ ì‹œì‘</button>
                <button id="btnPause" disabled>ì¼ì‹œ ì •ì§€</button>
            </div>
            <div id="statusMsg">ìƒíƒœ: ì—°ê²° ëŒ€ê¸°ì¤‘...</div>
        </div>

        <div class="control-group">
            <h3>ğŸ“Š ê·¸ë˜í”„ ì„¤ì •</h3>
            <div class="setting-item">
                <label>Xì¶• ë°ì´í„° ìˆ˜:</label>
                <span id="xRangeValue" style="font-weight:bold; color:var(--accent-color);">50</span>
            </div>
            <div class="setting-item">
                <input type="range" id="xRange" min="10" max="500" value="50">
            </div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
            <div class="radio-group">
                <label><input type="radio" name="yMode" value="auto" checked> Yì¶• ìë™</label>
                <label><input type="radio" name="yMode" value="manual"> Yì¶• ìˆ˜ë™</label>
            </div>
            <div class="setting-item">
                <label>Min:</label> <input type="number" id="yMin" disabled placeholder="0">
                <label>Max:</label> <input type="number" id="yMax" disabled placeholder="100">
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h3 style="margin-top:0;">ğŸ“ˆ ì‹¤ì‹œê°„ ë‹¤ì¤‘ ê·¸ë˜í”„</h3>
            <div class="sensor-legend" id="sensorLegend"></div>
            <div class="chart-container">
                <canvas id="sensorChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">ğŸ“ ë°ì´í„° ë¡œê·¸</h3>
            <div class="table-container">
                <table>
                    <thead id="tableHead">
                        <tr><th>ëŒ€ê¸°ì¤‘...</th></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ì„¤ì • ë° ë³€ìˆ˜ ---
    let port, reader, inputDone;
    let isConnected = false, isCollecting = false, isPaused = false;
    let dataCounter = 0;
    
    // ë‹¤ì¤‘ ì„¼ì„œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ êµ¬ì¡°: { time: string, values: [val1, val2...] }
    let allData = []; 
    let sensorCount = 0; // ê°ì§€ëœ ì„¼ì„œ ê°œìˆ˜

    // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ì„¼ì„œë³„ ê·¸ë˜í”„ ìƒ‰ìƒ)
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8e44ad'];

    // DOM ìš”ì†Œ
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const btnStart = document.getElementById('btnStart');
    const btnPause = document.getElementById('btnPause');
    const statusMsg = document.getElementById('statusMsg');
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const sensorLegend = document.getElementById('sensorLegend');
    
    const xRange = document.getElementById('xRange');
    const xRangeValue = document.getElementById('xRangeValue');
    const yModeRadios = document.getElementsByName('yMode');
    const yMinInput = document.getElementById('yMin');
    const yMaxInput = document.getElementById('yMax');

    // Chart.js ì´ˆê¸°í™”
    const ctx = document.getElementById('sensorChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { title: { display: true, text: 'ì‹œê°„' } },
                y: { title: { display: true, text: 'ê°’' } }
            }
        }
    });

    // --- ì‹œë¦¬ì–¼ í†µì‹  ë¡œì§ ---
    async function readSerialLoop() {
        const textDecoder = new TextDecoderStream();
        inputDone = port.readable.pipeTo(textDecoder.writable);
        reader = textDecoder.readable.getReader();
        let buffer = "";

        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value) {
                    buffer += value;
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); 
                    for (const line of lines) {
                        if (line.trim() && !isPaused) processData(line.trim());
                    }
                }
            }
        } catch (error) {
            console.error(error);
            statusMsg.innerText = "ìƒíƒœ: í†µì‹  ì˜¤ë¥˜";
        } finally {
            reader.releaseLock();
        }
    }

    // --- ë°ì´í„° ì²˜ë¦¬ í•µì‹¬ ë¡œì§ ---
    function processData(rawData) {
        // ì‰¼í‘œ(,)ë¡œ ë°ì´í„° ë¶„ë¦¬í•˜ê³  ê³µë°± ì œê±° í›„ ìˆ«ìë¡œ ë³€í™˜
        const values = rawData.split(',').map(v => parseFloat(v.trim()));
        
        // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ (í•˜ë‚˜ë¼ë„ ìˆ«ìê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ)
        if (values.some(isNaN) || values.length === 0) return;

        // ì²« ë°ì´í„° ìˆ˜ì‹  ì‹œ ì´ˆê¸°í™” (ì„¼ì„œ ê°œìˆ˜ íŒŒì•…)
        if (sensorCount === 0 || sensorCount !== values.length) {
            sensorCount = values.length;
            initTableAndChart(sensorCount);
        }

        dataCounter++;
        const now = new Date().toLocaleTimeString();

        // 1. ë°ì´í„° ì €ì¥
        allData.push({ id: dataCounter, time: now, values: values });

        // 2. í‘œ ì—…ë°ì´íŠ¸
        updateTable(dataCounter, now, values);

        // 3. ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        updateChart();
    }

    // ì´ˆê¸°í™”: í…Œì´ë¸” í—¤ë” ë° ì°¨íŠ¸ ë°ì´í„°ì…‹ ìƒì„±
    function initTableAndChart(count) {
        // í…Œì´ë¸” í—¤ë” ìƒì„±
        let headHtml = `<tr><th>ìˆœë²ˆ</th><th>ì‹œê°„</th>`;
        for(let i=0; i<count; i++) {
            headHtml += `<th>ì„¼ì„œ ${i+1}</th>`;
        }
        headHtml += `</tr>`;
        tableHead.innerHTML = headHtml;

        // ì°¨íŠ¸ ë°ì´í„°ì…‹ ì´ˆê¸°í™”
        chart.data.datasets = [];
        sensorLegend.innerHTML = ''; // ë²”ë¡€ ì´ˆê¸°í™”

        for(let i=0; i<count; i++) {
            const color = colors[i % colors.length];
            // ì°¨íŠ¸ ë°ì´í„°ì…‹ ì¶”ê°€
            chart.data.datasets.push({
                label: `ì„¼ì„œ ${i+1}`,
                data: [],
                borderColor: color,
                backgroundColor: color,
                borderWidth: 2,
                pointRadius: 1,
                tension: 0.2
            });
            // ë²”ë¡€ í‘œì‹œ ì¶”ê°€
            sensorLegend.innerHTML += `
                <div class="legend-item">
                    <div class="color-box" style="background:${color}"></div>
                    <span>ì„¼ì„œ ${i+1}</span>
                </div>
            `;
        }
    }

    // í‘œì— í–‰ ì¶”ê°€
    function updateTable(id, time, values) {
        let rowHtml = `<td>${id}</td><td>${time}</td>`;
        values.forEach(val => {
            rowHtml += `<td>${val}</td>`;
        });
        const row = document.createElement('tr');
        row.innerHTML = rowHtml;
        
        tableBody.prepend(row); // ìµœì‹  ë°ì´í„° ìƒë‹¨ ì¶”ê°€

        // í…Œì´ë¸” í–‰ì´ ë„ˆë¬´ ë§ì•„ì§€ë©´ ë©”ëª¨ë¦¬ ì •ë¦¬ë¥¼ ìœ„í•´ ì‚­ì œ (ì˜µì…˜)
        if(tableBody.children.length > 500) {
            tableBody.removeChild(tableBody.lastChild);
        }
    }

    // ì°¨íŠ¸ ë Œë”ë§
    function updateChart() {
        const windowSize = parseInt(xRange.value);
        const visibleData = allData.slice(-windowSize);

        chart.data.labels = visibleData.map(d => d.time);
        
        // ê° ì„¼ì„œë³„ë¡œ ë°ì´í„° ë°°ì—´ ì¶”ì¶œí•˜ì—¬ ì°¨íŠ¸ì— í• ë‹¹
        for(let i=0; i<sensorCount; i++) {
            if(chart.data.datasets[i]) {
                chart.data.datasets[i].data = visibleData.map(d => d.values[i]);
            }
        }
        chart.update();
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    btnConnect.addEventListener('click', async () => {
        try {
            if(!("serial" in navigator)) return alert("Web Serial ë¯¸ì§€ì› ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            isConnected = true;
            updateUIState();
            statusMsg.innerText = "ìƒíƒœ: ì—°ê²°ë¨ (ëŒ€ê¸°ì¤‘)";
            statusMsg.style.color = "#27ae60";
        } catch (e) { console.error(e); alert("ì—°ê²° ì‹¤íŒ¨"); }
    });

    btnDisconnect.addEventListener('click', async () => {
        if(reader) { await reader.cancel(); await inputDone.catch(()=>{}); reader=null; inputDone=null; }
        if(port) { await port.close(); port=null; }
        isConnected = isCollecting = isPaused = false;
        sensorCount = 0; // ì—°ê²° í•´ì œ ì‹œ ì„¼ì„œ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
        updateUIState();
        statusMsg.innerText = "ìƒíƒœ: ì—°ê²° í•´ì œë¨";
        statusMsg.style.color = "#c0392b";
    });

    btnStart.addEventListener('click', () => {
        if(!isConnected) return;
        if(!isCollecting) { isCollecting=true; readSerialLoop(); }
        isPaused = false;
        btnStart.disabled = true;
        btnPause.disabled = false;
        btnPause.innerText = "ì¼ì‹œ ì •ì§€";
        statusMsg.innerText = "ìƒíƒœ: ë°ì´í„° ìˆ˜ì§‘ ì¤‘...";
    });

    btnPause.addEventListener('click', () => {
        if(!isCollecting) return;
        isPaused = !isPaused;
        btnPause.innerText = isPaused ? "ë‹¤ì‹œ ì‹œì‘" : "ì¼ì‹œ ì •ì§€";
        statusMsg.innerText = isPaused ? "ìƒíƒœ: ì¼ì‹œ ì •ì§€ë¨" : "ìƒíƒœ: ë°ì´í„° ìˆ˜ì§‘ ì¤‘...";
    });

    function updateUIState() {
        btnConnect.disabled = isConnected;
        btnDisconnect.disabled = !isConnected;
        btnStart.disabled = !isConnected || isCollecting;
        btnPause.disabled = !isCollecting;
    }

    // UI ì„¤ì • ì´ë²¤íŠ¸
    xRange.addEventListener('input', (e) => {
        xRangeValue.innerText = e.target.value;
        updateChart();
    });
    
    yMinInput.addEventListener('input', updateScales);
    yMaxInput.addEventListener('input', updateScales);
    yModeRadios.forEach(r => r.addEventListener('change', (e) => {
        const isManual = e.target.value === 'manual';
        yMinInput.disabled = !isManual;
        yMaxInput.disabled = !isManual;
        updateScales();
    }));

    function updateScales() {
        const mode = document.querySelector('input[name="yMode"]:checked').value;
        if (mode === 'auto') {
            chart.options.scales.y.min = null;
            chart.options.scales.y.max = null;
        } else {
            const min = parseFloat(yMinInput.value);
            const max = parseFloat(yMaxInput.value);
            if(!isNaN(min)) chart.options.scales.y.min = min;
            if(!isNaN(max)) chart.options.scales.y.max = max;
        }
        chart.update();
    }
</script>
</body>
</html>
